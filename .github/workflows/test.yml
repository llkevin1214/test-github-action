name: deployment

on:
  push:
    branches:
      - "testing"

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name || github.head_ref }}
    concurrency:
      group: ${{ github.ref }}
      cancel-in-progress: true


    steps:
      - name: Search PR
        uses: actions/github-script@v7
        id: search-pr
        with:
          result-encoding: json
          script: |
            core.info(`search pr`);

            const { data: all_pull_requests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: 'production',
              state: 'open',
            })

            let targetCommit = null;
            let targetPR = null;

            for(const pr of all_pull_requests) {
              const commits = await github.rest.pulls.listCommits({
                owner: context.repo.owner,
                pull_number: pr.number,
                repo: context.repo.repo,
              })
              for(const commit of commits.data) {
                core.info(`commit: ${JSON.stringify(commit)}`)
              }
            }

            return all_pull_requests;